Self-Distilled Disentangled Learning for Counterfactual
Prediction
Xinshu Li
xinshu.li@unsw.edu.au
The University of New South Wales
Sydney, AustraliaMingming Gong
mingming.gong@unimelb.edu.au
The University of Melbourne
Melbourne, Australia
MBZUAI
Abu Dhabi, United Arab EmiratesLina Yao
lina.yao@data61.csiro.au
CSIROâ€™s Data 61
The University of New South Wales
Sydney, Australia
ABSTRACT
The advancements in disentangled representation learning signifi-
cantly enhance the accuracy of counterfactual predictions by grant-
ing precise control over instrumental variables, confounders, and
adjustable variables. An appealing method for achieving the in-
dependent separation of these factors is mutual information min-
imization, a task that presents challenges in numerous machine
learning scenarios, especially within high-dimensional spaces. To
circumvent this challenge, we propose the Self-Distilled Disentan-
glement framework, referred to as ğ‘†ğ·2. Grounded in information
theory, it ensures theoretically sound independent disentangled
representations without intricate mutual information estimator de-
signs for high-dimensional representations. Our comprehensive
experiments, conducted on both synthetic and real-world datasets,
confirms the effectiveness of our approach in facilitating counter-
factual inference in the presence of both observed and unobserved
confounders.
CCS CONCEPTS
â€¢Computing methodologies â†’Learning latent representa-
tions.
KEYWORDS
Counterfactual Prediction, Disentangled Representation Learning,
Information Theory
ACM Reference Format:
Xinshu Li, Mingming Gong, and Lina Yao. 2024. Self-Distilled Disentangled
Learning for Counterfactual Prediction. In Proceedings of the 30th ACM
SIGKDD Conference on Knowledge Discovery and Data Mining (KDD â€™24),
August 25â€“29, 2024, Barcelona, Spain. ACM, New York, NY, USA, 12 pages.
https://doi.org/10.1145/3637528.3671782
1 INTRODUCTION
Counterfactual prediction has attracted increasing attention [ 1,
10,12,48] in recent years due to the rising demands for robust
and trustworthy artificial intelligence. Confounders, the common
Permission to make digital or hard copies of all or part of this work for personal or
classroom use is granted without fee provided that copies are not made or distributed
for profit or commercial advantage and that copies bear this notice and the full citation
on the first page. Copyrights for components of this work owned by others than the
author(s) must be honored. Abstracting with credit is permitted. To copy otherwise, or
republish, to post on servers or to redistribute to lists, requires prior specific permission
and/or a fee. Request permissions from permissions@acm.org.
KDD â€™24, August 25â€“29, 2024, Barcelona, Spain
Â©2024 Copyright held by the owner/author(s). Publication rights licensed to ACM.
ACM ISBN 979-8-4007-0490-1/24/08
https://doi.org/10.1145/3637528.3671782causes of treatments and effects, induce spurious relations between
different variables, consequently undermining the distillation of
causal relations from associations. Thanks to the rapid development
of representation learning, a plethora of methods [22, 33, 44] miti-
gate the bias caused by the observed confounders via generating
balanced representations in the latent space. As for the bias brought
by the unobserved confounders, Angrist and Imbens [3], Hartford
et al. [14] , Lin et al . [24] , Muandet et al . [27] , Pearl et al . [28] pro-
pose obtaining an unbiased estimator by regressing outcomes on
Instrumental variables (IVs), which are exogenous variables related
to treatment and only affect outcomes indirectly via treatment, to
break the information flow between unobserved confounders and
the treatments.
We will further clarify by integrating Figure 1 with a real-world
example. Hoxby [17] examined whether competition among public
schools (Treatment T) improves educational quality within districts
(Outcome Y). The potential endogeneity of the number of schools
in a region arises because both the treatment and the outcome
could be influenced by long-term factors (Confounders) specific
to the area. Some of these confounders (observed Confounders C)
can be measured, such as the level of local economic development.
However, other confounders (Unobserved Confounders U) cannot
be easily quantified or exhaustively listed, such as certain historical
factors. River counts here can serve as a persuasive IV: 1) more
rivers can lead to more schools due to transportation (Relevance);
2) yet they are unrelated to teaching quality directly (Exclusivity);
3) the natural attributes of river formation render the counts of
the rivers unrelated to the confounders caused by historical factors
(Exogeneity).
There are two drawbacks to the existing methods. Firstly, most
of them treat all observed features as the observed confounders to
block, while only part contributes to the distribution discrepancy
of pre-treatment features. Secondly, the prerequisite for IV-based
regression methods is to access valid IVs, which have three strict
conditions (Relevance, Exclusion, Exogeneity) to satisfy, as shown
above, making it a thorny task to find.
Disentangled representation learning [ 8,15,41,45], aiming at
decomposing the representations of different underlying factors
from the observed features, is showing promise in addressing the
flaws above simultaneously. The disentangled factors provide us
with a more precise inference route to alleviate the bias brought
by the observed confounders. Additionally, one can automatically
obtain the representations of the valid IVs to remove the bias led
by the unobserved confounders.
The seminar work by Hassanpour and Greiner [15] introduces
disentangled learning to the domain of counterfactual prediction,
 
1667
KDD â€™24, August 25â€“29, 2024, Barcelona, Spain Xinshu Li, Mingming Gong, and Lina Yao
creatively categorizing observed features into instrumental vari-
ables (IVs), confounders, and adjustable variables. However, it does
not guarantee the generation of mutually independent representa-
tions of these underlying factors. Subsequently, Cheng et al . [8], Wu
et al. [41] , Yuan et al . [45] integrate effective mutual information
estimators [ 9] to minimize the mutual information between latent
factor representations, aiming to achieve mutually independent la-
tent representations. Nonetheless, the accurate estimation of mutual
information between high-dimensional representations remains a
persistent challenge [ 5,29]. Inaccurate estimation of mutual infor-
mation may result in the failure to obtain mutually independent
representations of latent factors, thereby compromising the accu-
racy of counterfactual estimation.
To overcome the defects of previous methods, we propose a
novel algorithm for counterfactual prediction named Self-Distilled
Disentanglement ( ğ‘†ğ·2) to sidestep MI estimation between high-
dimensional representations. Specifically, we provide theoretical
analysis rooted in information theory to guarantee the mutual inde-
pendence of diverse underlying factors. Further, we give a solvable
form of our method through rigorous mathematical derivation to
minimize MI directly rather than explicitly estimating it. Based
on the theory put forward, we design a hierarchical distillation
framework to kill three birds with one stone: disentangle three
independent underlying factors, mitigate the confounding bias, and
grasp sufficient supervision information for counterfactual predic-
tion.
Our main contributions are summarized as follows:
â€¢We put forward a theoretically assured solution rooted in
information theory for disentanglement to avoid mutual
information estimation between high-dimensional represen-
tations. It enables the generation of mutually independent
representations, thereby adding in the decomposition of di-
verse underlying factors.
â€¢We provide a tractable form of proposed solution through
mathematically rigorous derivation, which rewrites the loss
function of disentanglement and fundamentally tackles the
difficulty of mutual information estimation between high-
dimensional representations.
â€¢We propose a novel self-distilled disentanglement method
(ğ‘†ğ·2) for counterfactual prediction. By designing a hierar-
chical distillation framework, we disentangle IVs and con-
founders from observational data to mitigate the bias induced
by the observed and unobserved confounders at the same
time.
â€¢We conduct extensive experiments on synthetic and real-
world benchmarks to verify our theoretically grounded strate-
gies. The results demonstrate the effectiveness of our frame-
work on counterfactual prediction compared with the state-
of-the-art baselines.
2 RELATED WORK
2.1 Counterfactual Prediction
The main challenge for counterfactual prediction is the existence
of confounders. Researchers adopt matching [ 32], re-weighting
[18], regression [ 11], representation learning [ 33,49] to alleviate
X
C Z A
T Y
UObserved Variables:
Z
C
ATX
UY
Decomposed hidden factors:
Unobserved Variables:Pre-treatment features
Treatment
Outcome
Instrumental variables
Confounder variables
Adjustment variables
Unobserved confoundersFigure 1: General causal structure. The underlying con-
foundersğ¶in observed pre-treatment features ğ‘‹and un-
observed confounders ğ‘ˆresult in spurious relations rather
than causal relations between treatment ğ‘‡and outcome ğ‘Œ.
We aim to disentangle mutually independent representations
ofğ‘,ğ¶, andğ´fromğ‘‹without the design of intrigue mutual
information estimators.
the confounding bias under the â€œno hidden confounders" assump-
tion. To relax this unpractical assumption, a few non-parametric
or semi-parametric methods utilize special structures among the
variables to resolve the bias led by the unobserved confounders.
These structures include (1) proxy variables [ 25,35,36,42]; (2)
multiple causes [ 7,37,46]; (3) instrumental variables. 2SLS [ 3] is
the classical IV method in a linear setting. Hartford et al . [14] , Lin
et al. [24] , Singh et al . [34] , Wu et al . [39] , Xu et al . [43] adopt ad-
vanced machine learning or deep learning algorithms for non-linear
scenarios. Another commonly used causal effects estimator using
IVs is the control function estimator (CFN) [ 30,38]. These meth-
ods require well-predefined IVs or assume all observed features
as confounders, which inevitably impairs their generalization to
real-world practice. Li and Yao [23], Wu et al . [40] , Yuan et al . [45]
aims to generate IVs for downstream IV-based methods rather than
focusing on counterfactual prediction.
2.2 Disentangled Representation Learning
Most of the current state-of-the-art disentangled representation
learning methods are based on Kingma and Welling [21], which uses
a variational approximation posterior for the inference process of
the latent variables. Typical work includes ğ›½-VAE [ 16], Factor-VAE
[19], CEVAE [ 25] and so on. Another popular solution [ 6,50] builds
on the basis of Generative Adversarial Networks [ 13]. However,
these studies are more suitable for the approximate data generation
problem and fall short when it comes to estimating causal effects,
largely due to the difficulty in training complex generation models.
As the disentanglement of the underlying factors in observed
features helps to alleviate confounding bias and improve inference
accuracy, Hassanpour and Greiner [15], Wu et al . [41] , Zhang et al .
[47] design different decomposition regularizers to help the sepa-
ration of underlying factors. However, these methods fall short in
obtaining disentangled representations that are mutually indepen-
dent, which is a prerequisite for identifying treatment effects. Cheng
et al. [8], Yuan et al . [45] employ a cutting-edge mutual information
 
1668Self-Distilled Disentangled Learning for Counterfactual Prediction KDD â€™24, August 25â€“29, 2024, Barcelona, Spain
estimator [ 9] to reduce the mutual information between disentan-
gled representations, thereby promoting independence among the
representations of underlying factors. Despite this, the intricacy of
mutual information estimation poses a challenge to the accurate
separation of latent factors, thereby leaving room for enhancement
in counterfactual prediction.
Compared with previous IV-based counterfactual prediction
methods,ğ‘†ğ·2abandons well-predefined IVs but rather decomposes
them from pre-treatment variables. Besides, we only impose con-
ditions on variables that are related to confounding bias. Hence,
our approach effectively mitigates both unobserved and observed
confounding biases concurrently, a feat rarely achieved by previous
IV-based counterfactual prediction methods. Compared with gener-
ative disentangled methods, rather than generating latent variables,
ğ‘†ğ·2directly disentangles the observed features into three under-
lying factors by introducing causal mechanisms, which is more
efficient and effective. In contrast to preceding causal disentangle-
ment methods, our approach facilitates the generation of mutually
independent representations of underlying factors without the need
for intricate mutual information estimators. Instead, we fundamen-
tally minimize the mutual information between the representations
of underlying factors without explicit estimation, which will be
elaborated in Section 4.
3 PROBLEM SETUP
As shown in Figure 1, we have observed pre-treatment features ğ‘‹,
treatmentğ‘‡, and outcome ğ‘Œin the datasetD.ğ‘‹is composed of
three types of underlying factors:
â€¢Instrumental variable ğ‘that only directly influences ğ‘‡.
â€¢Confounders ğ¶that directly influences both ğ‘‡andğ‘Œ.
â€¢Adjustable variable ğ´that only directly influences ğ‘Œ.
Besides these, there are some Unobserved confounders ğ‘ˆthat
impede the counterfactual prediction. ğ‘,ğ¶,ğ´,ğ‘ˆ in this paper are
exogenous variables.
According to the d-separation theory [ 28],ğ‘,ğ¶andğ´are mu-
tually independent due to the collider structures ğ‘â†’ğ‘‡â†ğ¶and
ğ¶â†’ğ‘Œâ†ğ´. Thus, encouraging independence among the repre-
sentations of these underlying factors is essential for advancing
their separation. In this paper, we aim to first disentangle mutually
independent representations of ğ‘,ğ¶, andğ´fromğ‘‹, bypassing the
explicit estimation of mutual information through theoretical anal-
ysis, then propose a unified framework to tackle confounding bias
caused byğ¶andğ‘ˆsimultaneously.
Given the above definitions, we present the formal definitions
of counterfactual prediction problem, followed by an essential as-
sumption for identification of causal effects adopted in this paper.
Definition 3.1. Counterfactual Prediction refers to predicting
what the outcome would have been for an individual under an
intervention ğ‘¡[28], i.e.,
ğ‘”(ğ‘¡,ğ‘‹)=ğ¸[ğ‘Œ|ğ‘‘ğ‘œ(ğ‘‡=ğ‘¡),ğ‘‹], (1)
where dorefers to do-operator proposed by Pearl et al. [28].
Assuming successful separation of ğ‘,ğ¶, andğ´, the sufficient
identification results for causal effects under the additive noiseassumption in instrumental variable regression were developed by
Angrist et al. [4].
Assumption 3.2. Additive Noise Assumption: the noise from
unmeasured confounders ğ‘ˆis added to the outcomes ğ‘Œ, i.e.,
ğ‘Œ=ğ‘”(ğ‘¡,ğ‘‹)+ğ‘ˆ. (2)
4 METHODOLOGY
4.1 Theoretical Foundation of Independentizing
Underlying Factors
To get the mutually independent representations of underlying
factors, an intuitive thought is to minimize the mutual informa-
tion between the representation of ğ‘,ğ¶andğ´, i.e.,ğ¼(ğ‘…ğ‘;ğ‘…ğ‘)1and
ğ¼(ğ‘…ğ‘§;ğ‘…ğ‘), whereğ¼(Â·)represents the function of mutual information,
during training. However, it is hard due to the notorious difficulty
in estimating mutual information in high dimensions, especially
for latent embedding optimization [ 5,29]. To circumvent this chal-
lenge, we decompose the mutual information between ğ‘…ğ‘andğ‘…ğ‘
by leveraging the chain rule of mutual information:
ğ¼(ğ‘…ğ‘;ğ‘…ğ‘)=ğ¼(ğ‘Œ;ğ‘…ğ‘)+ğ¼(ğ‘…ğ‘;ğ‘…ğ‘|ğ‘Œ)âˆ’ğ¼(ğ‘…ğ‘;ğ‘Œ|ğ‘…ğ‘). (3)
We further inspect the term ğ¼(ğ‘…ğ‘;ğ‘…ğ‘|ğ‘Œ)in Eq (3). Based on the
definition of mutual information, we have,
ğ¼(ğ‘…ğ‘;ğ‘…ğ‘|ğ‘Œ)=ğ»(ğ‘…ğ‘|ğ‘Œ)âˆ’ğ»(ğ‘…ğ‘|ğ‘Œ,ğ‘…ğ‘), (4)
whereğ»(Â·)represents the function of entropy. Intuitively, this con-
ditional mutual information measures the information contained in
ğ‘…ğ‘that is related to ğ‘…ğ‘but unrelated to ğ‘Œ. Empirically, if we set up
two prediction models from ğ‘…ğ‘andğ‘…ğ‘to Y, respectively, then the
mutual information between ğ‘…ğ‘andğ‘…ğ‘is all related to ğ‘Œduring the
training phase. We draw the Venn diagram of mutual information
betweenğ‘…ğ‘,ğ‘…ğ‘andğ‘Œas shown in Figure 2, according to which we
have,
ğ»(ğ‘…ğ‘|ğ‘Œ)=ğ»(ğ‘…ğ‘|ğ‘Œ,ğ‘…ğ‘). (5)
With Eq (3), (4) and (5), during the training phase, we have,
ğ¼(ğ‘…ğ‘;ğ‘…ğ‘)=ğ¼(ğ‘Œ;ğ‘…ğ‘)âˆ’ğ¼(ğ‘…ğ‘;ğ‘Œ|ğ‘…ğ‘). (6)
Eq(6)transforms the mutual information between two training
high-dimensional representations into the subtraction of two mu-
tual information estimators with known labels, thereby decreasing
the difficulty of the computation. To further simplify it, we intro-
duce the following theory:
Theorem 4.1. Minimizing the mutual information between ğ‘…ğ‘
andğ‘…ğ‘is equivalent to:
minğ»(ğ‘Œ)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)+ğ»(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘). (7)
To find a tractable solution to Eq (7), we derive the following
Corollary:
1ğ‘…ğ‘andğ‘…ğ‘differ fromğ´andğ¶in Figure 1. Our optimization aims to bring ğ‘…ğ‘and
ğ‘…ğ‘to the states where ğ´andğ¶can be represented. Initially, ğ‘…ğ‘andğ‘…ğ‘are entangled
with non-zero mutual information and thus do not follow the causal relations in Figure
1, as depicted in Figure 2. We introduce constraints to reduce their MI and achieve
independence.
 
1669KDD â€™24, August 25â€“29, 2024, Barcelona, Spain Xinshu Li, Mingming Gong, and Lina Yao
ğ‘¯(ğ‘¹ğ’„|ğ’€,ğ‘¹ğ’‚)
ğ‘¯(ğ’€|ğ‘¹ğ’„,ğ‘¹ğ’‚)ğ‘°(ğ‘¹ğ’„;ğ‘¹ğ’‚)
ğ‘°(ğ‘¹ğ’„;ğ’€|ğ‘¹ğ’‚)ğ‘¯(ğ‘¹ğ’„) ğ‘¯(ğ‘¹ğ’‚)
ğ‘¯(ğ’€)ğ‘¯(ğ‘¹ğ’‚|ğ’€,ğ‘¹ğ’„)
ğ‘°(ğ‘¹ğ’‚;ğ’€|ğ‘¹ğ’„)(ğ‘¯ğ‘¹ğ’„ğ’€) (ğ‘¯ğ‘¹ğ’‚ğ’€)
Figure 2: A motivating Venn diagram of mutual information
betweenğ‘…ğ‘,ğ‘…ğ‘andğ‘Œduring training phase.
Corollary 4.2. One of sufficient conditions of minimizing ğ¼(ğ‘…ğ‘;ğ‘…ğ‘)
is minimizing the following conditions together:
minLğ‘
ğ‘=(
ğ·ğ¾ğ¿[Pğ‘Œâˆ¥Pğ‘…ğ‘
ğ‘Œ] (8a)
ğ·ğ¾ğ¿[Pğ‘…ğ‘
ğ‘Œâˆ¥Pğ‘…ğ‘
ğ‘Œ], (8b)
wherePğ‘…ğ‘
ğ‘Œ=ğ‘(ğ‘Œ|ğ‘…ğ‘),Pğ‘…ğ‘
ğ‘Œ=ğ‘(ğ‘Œ|ğ‘…ğ‘)represent the predicted
distributions of ğ‘Œ,Pğ‘Œ=ğ‘(ğ‘Œ)represents the real distribution of ğ‘Œ.
ğ·ğ¾ğ¿denotes the KL-divergence.
Detailed proof and formal assertions of Theo.4.1 andCorol.4.2
can be found in the Appendix A.1.1 and A.1.2. Similarly, we can
transform minimizing ğ¼(ğ‘…ğ‘§;ğ‘…ğ‘)into following:
minLğ‘§
ğ‘=(
ğ·ğ¾ğ¿[Pğ‘‡âˆ¥Pğ‘…ğ‘§
ğ‘‡] (9a)
ğ·ğ¾ğ¿[Pğ‘…ğ‘§
ğ‘‡âˆ¥Pğ‘…ğ‘
ğ‘‡], (9b)
wherePğ‘…ğ‘
ğ‘‡=ğ‘(ğ‘‡|ğ‘…ğ‘),Pğ‘…ğ‘§
ğ‘‡=ğ‘(ğ‘‡|ğ‘…ğ‘§)represent the predicted
distributions of ğ‘‡,Pğ‘‡=ğ‘(ğ‘‡)represents the real distribution of ğ‘‡.
Remark: Technically, the optimization of Eq (8a),(8b)can be
realized by training prediction networks about ğ‘Œ. Additionally,
we can set up a deep prediction network from ğ‘‡,ğ´,ğ¶toğ‘Œand
use its supervision information to guide the training of the shallow
prediction models. From this perspective, our approach is essentially
a self-distillation model. Therefore, we name our method as Self-
Distilled Disentanglement, i.e., ğ‘†ğ·2.
4.2 Self-Distilled Disentanglement Framework
With the theory put forward in section 4.1, we propose a self-
distilled framework to disentangle different mutually independent
underlying factors. To clarify further, we take the distillation unit
for minimizingLğ‘§ğ‘to illustrate how we employ different sources of
supervision information to directly minimize mutual information
without explicitly estimating it.
As shown in Figure 3, Retain network represents the neural
network for retaining the information from both ğ‘andğ¶.Deep
networks and Shallow networks are named based on their relative
proximity to ğ‘…ğ‘§andğ‘…ğ‘. We set up two Shallow prediction networks
fromğ‘…ğ‘§andğ‘…ğ‘toğ‘‡, respectively. In addition, to ensure ğ‘…ğ‘§andğ‘…ğ‘
grasp sufficient information for predicting ğ‘‡, we set up a Retain
network to concatenate ğ‘…ğ‘§andğ‘…ğ‘and store joint information of
ğ‘¹ğ’›ğ‘¹ğ’„ğ‘¹ğ‘»ğ‘¸ğ‘»ğ’›ğ‘¸ğ‘»ğ’„ğ‘¸ğ‘»ğ‘»Forward FlowSupervision from LabelsSupervision from TeachersSupervision from PeersNeural NetworksshallowshallowdeepretainFigure 3: Self-distillation unit for minimizing Lğ‘§ğ‘.
them for input into a Deep prediction network. To minimize Lğ‘§ğ‘,
we deploy distinct sources of supervision information from:
(1)Labels; We useğ‘‡directly to guide the training of deep
prediction networks by minimizing the prediction loss ğ¿(ğ‘„ğ‘‡,ğ‘‡).
For shallow prediction networks, we reduce ğ·ğ¾ğ¿[Pğ‘‡âˆ¥Pğ‘…ğ‘§
ğ‘‡]and
ğ·ğ¾ğ¿[Pğ‘‡âˆ¥Pğ‘…ğ‘
ğ‘‡]by minimizing prediction loss ğ¿(ğ‘„ğ‘§
ğ‘‡,ğ‘‡)andğ¿(ğ‘„ğ‘
ğ‘‡,ğ‘‡).2
(2)Teachers; We regard retain and deep prediction networks as
a teacher model, which can convey the learned knowledge to help
the training of shallow prediction networks. That is, minimizing
KL-divergence loss ğ¿(ğ‘„ğ‘§
ğ‘‡,ğ‘„ğ‘‡)andğ¿(ğ‘„ğ‘
ğ‘‡,ğ‘„ğ‘‡).
(3)Peers; We diminish the KL-divergence between the distribu-
tions of the outputs from the two shallow prediction networks, i.e.,
ğ¿(ğ‘„ğ‘
ğ‘‡,ğ‘„ğ‘§
ğ‘‡).ğ·ğ¾ğ¿[Pğ‘…ğ‘§
ğ‘‡âˆ¥Pğ‘…ğ‘
ğ‘‡]are consequently minimized. Similarly,
we can minimizeLğ‘ğ‘by establishing corresponding distillation
units according to Corol.4.2. In addition, Hassanpour and Greiner
[15] propose to separate ğ´fromğ‘‹based onğ´âŠ¥ğ‘‡. Specifically,
for binary treatment setting, they minimize the distribution dis-
crepancy of representations of ğ´between the treatment group ( ğ‘‡=
1) and the control group ( ğ‘‡= 0). The related loss function can be
defined as follows:
minLğ‘=ğ‘‘ğ‘–ğ‘ ğ‘({ğ‘…ğ‘–
ğ‘}ğ‘–:ğ‘¡ğ‘–=0,{ğ‘…ğ‘–
ğ‘}ğ‘–:ğ‘¡ğ‘–=1), (10)
where function ğ‘‘ğ‘–ğ‘ ğ‘(Â·)represents the distribution discrepancy of
ğ‘…ğ‘between the treatment and control groups while irefers to the
i-thindividual. We also provide continuous version of Lğ‘in the
Appendix A.2.1.
Mitigating Confounding Bias: With disentangled confounders
ğ¶,the confounding bias induced by ğ¶can be alleviated by re-
weighting the factual loss ğ¿(ğ‘„ğ‘Œ,ğ‘Œ)with the context-aware impor-
tance sampling weights ğœ”ğ‘–[15] for each individual ğ‘–. Besides,ğ‘„ğ‘‡,
the output of the deep prediction network for ğ‘‡, can be employed to
regressğ‘Œ, which helps to mitigate the confounding bias caused
by unobserved confounders ğ‘ˆ[14].
The loss function of ğ‘†ğ·2is thus devised as follows, where ğ¿can
be any functions measuring the differences between two items. ğ›¼,
ğ›½,ğ›¾,ğ›¿are adjustable hyper-parameters. The ğ‘™2regularization loss
2In practice, only minimizing Eq (9a)and(9b)makes convergence challenging, resulting
in unsatisfactory performance. We speculate that this is due to a lack of sufficient
supervised information guiding the updating direction of the prediction network for
ğ‘…ğ‘. Therefore, we introduce the minimization of ğ·ğ¾ğ¿[Pğ‘‡âˆ¥Pğ‘…ğ‘
ğ‘‡](corresponding loss
functionğ¿(ğ‘„ğ‘
ğ‘‡,ğ‘‡)to expedite loss convergence.
 
1670Self-Distilled Disentangled Learning for Counterfactual Prediction KDD â€™24, August 25â€“29, 2024, Barcelona, Spain
âˆ¥Â·âˆ¥ 2on model weights ğ‘Šis to avoid over-fitting.
Lğ‘†ğ·2=âˆ‘ï¸
ğ‘–ğœ”ğ‘–ğ¿(ğ‘„ğ‘Œğ‘–,ğ‘Œğ‘–)+ğ›¼ğ¿(ğ‘„ğ‘‡,ğ‘‡)
|                                {z                                }
ğ‘“ğ‘ğ‘ğ‘¡ğ‘¢ğ‘ğ‘™ğ‘™ğ‘œğ‘ ğ‘ +
ğ›½Lğ‘+ğ›¾(Lğ‘
ğ‘+Lğ‘§
ğ‘)
|                  {z                  }
ğ‘‘ğ‘–ğ‘ ğ‘’ğ‘›ğ‘¡ğ‘ğ‘›ğ‘”ğ‘™ğ‘’ğ‘šğ‘’ğ‘›ğ‘¡ğ‘™ğ‘œğ‘ ğ‘ +ğ›¿âˆ¥ğ‘Šâˆ¥2|  {z  }
ğ‘Ÿğ‘’ğ‘”ğ‘¢ğ‘™ğ‘ğ‘Ÿğ‘–ğ‘§ğ‘ğ‘¡ğ‘–ğ‘œğ‘›ğ‘™ğ‘œğ‘ ğ‘ .(11)
5 EXPERIMENTS
5.1 Benchmarks
Due to the absence of counterfactual outcomes in reality, it is chal-
lenging to conduct counterfactual prediction on real-world datasets.
Previous works [ 22,33,41] synthesize datasets or transform real-
world datasets. In this paper, we have conducted multiple exper-
iments on a series of synthetic datasets and a real-world dataset,
Twins. The source code of our algorithm is available on GitHub3.
5.1.1 Simulated Datasets. Binary Scenario : Similar to Hassanpour
and Greiner [15]4, we generate the synthetic datasets according to
the following steps:
â€¢Forğ¾inğ‘,ğ¶,ğ´,ğ‘‰,ğ‘ˆ, sampleğ¾fromN(0,ğ¼ğ‘šğ‘˜), whereğ¼ğ‘šğ‘˜
denotesğ‘šğ‘˜degree identity matrix. Concatenate ğ‘,ğ¶, andğ´
to constitute the observed covariates matrix ğ‘‹.ğ‘‰represents
the observed IVs, the dimension of which could be set to 0.
The setting of ğ‘‰is mainly for the comparison of IV-based
methods.ğ‘ˆrepresents the unobserved confounders.
â€¢Sample treatment variables ğ‘‡as following:
ğ‘‡ğ‘–âˆ¼ğµğ‘’ğ‘Ÿğ‘›(ğ‘†ğ‘–ğ‘”ğ‘šğ‘œğ‘–ğ‘‘(
ğ‘šğ‘§âˆ‘ï¸
ğ‘–=1ğ‘ğ‘–+ğ‘šğ‘âˆ‘ï¸
ğ‘–=1ğ¶ğ‘–+ğ‘šğ‘£âˆ‘ï¸
ğ‘–=1ğ‘‰ğ‘–+ğ‘šğ‘¢âˆ‘ï¸
ğ‘–=1ğ‘ˆğ‘–)),(12)
whereğ‘šğ‘§,ğ‘šğ‘,ğ‘šğ‘£,ğ‘šğ‘¢represent the dimension of ğ‘,ğ¶,ğ‘‰,
ğ‘ˆrespectively.
â€¢Sample outcome variables ğ‘Œas following:
ğ‘Œğ‘–âˆ¼ğµğ‘’ğ‘Ÿğ‘›(ğ‘†ğ‘–ğ‘”ğ‘šğ‘œğ‘–ğ‘‘((
ğ‘‡ğ‘–
ğ‘šğ‘+ğ‘šğ‘+ğ‘šğ‘¢ğ‘šğ‘âˆ‘ï¸
ğ‘–=1ğ´ğ‘–2+ğ‘šğ‘âˆ‘ï¸
ğ‘–=1ğ¶ğ‘–2+ğ‘šğ‘¢âˆ‘ï¸
ğ‘–=1ğ‘ˆğ‘–2)+
(1âˆ’ğ‘‡ğ‘–
ğ‘šğ‘+ğ‘šğ‘+ğ‘šğ‘¢ğ‘šğ‘âˆ‘ï¸
ğ‘–=1ğ´ğ‘–+ğ‘šğ‘âˆ‘ï¸
ğ‘–=1ğ¶ğ‘–+ğ‘šğ‘¢âˆ‘ï¸
ğ‘–=1ğ‘ˆğ‘–))),(13)
whereğ‘šğ‘represents the dimension of ğ´.
Continuous Scenario : Following the work of Hartford et al .
[14], Wu et al . [39] , we use the Demand datasets to evaluate the
performance of ğ‘†ğ·2on the continuous scenario with the same data
generation process described in detail in Wu et al. [39].
3https://github.com/XinshuLI2022/SDD
4The difference between our data generation process and that of Hassanpour and
Greiner [15] lies in the introduction of unobserved confounders ğ‘ˆ, in the generation
processes ofğ‘‡andğ‘Œ. Additionally, we categorize IVs into observed and unobserved
ones, facilitating comparisons with various baseline algorithms.5.1.2 Real-World Datasets. Twins : The Twins dataset comprises the
records of the twins who were born between 1989-1991 in the USA
[2]. We select 5271 records of same-sex twins who weighed less than
2kg and had no missing features in the records. The heavier twin
in twins is assigned with ğ‘‡= 1 and the lighter one with ğ‘‡= 0. The
mortality after one year is the observed outcome. It is reasonable
that only part of the features determine the outcome. Therefore, we
randomly generate ğ‘šğ‘£-dimensionğ‘‰and choose some features ğ‘€as
a combination of ğ‘,ğ¶andğ‘ˆto createğ‘‡according to the policy in
Eq.(12). The rest features ğ‘…will include ğ´and some noise naturally.
We hide some features in ğ‘€during training to create ğ‘ˆand treat
the rest features in ğ‘€withğ‘…asğ‘‹.
During training, only ğ‘‹,ğ‘‰,ğ‘‡andğ‘Œwill be accessible under any
scenario.
5.2 Comparison Methods and Metrics
Thebaselines can be classified into two categories:
IV-based Methods: DeepIV-Log and DeepIV-Gmm [ 14], DFIV
[43], OneSIV [ 24], CBIV [ 39]. These methods need well-predefined
IVsğ‘‰. When there is no ğ‘‰, i.e.,ğ‘šğ‘£equals 0, we use ğ‘‹asğ‘‰for
comparison.
Non-IV-based Methods: DirectRep, CFR-Wass [ 33], DFL [ 43],
DRCFR [ 15], CEVAE [ 25]. The latter two also disentangle the hid-
den/latent factors from observed features.
Metrics: We use the absolute bias of Average Treatment Effect,
i.e.,ğœ–ğ´ğ‘‡ğ¸ , to evaluate the performance of different algorithms in
the binary scenario. Formally,
ğœ–ğ´ğ‘‡ğ¸ =|1
ğ‘[ğ‘âˆ‘ï¸
ğ‘–=1(ğ‘Œ1
ğ‘–âˆ’ğ‘Œ0
ğ‘–)âˆ’ğ‘âˆ‘ï¸
ğ‘–=1(Ë†ğ‘Œ1
ğ‘–âˆ’Ë†ğ‘Œ0
ğ‘–)]|, (14)
whereğ‘Œğ‘–/Ë†ğ‘Œğ‘–represents the factual/predicted potential outcome.
For continuous scenarios, we take Mean Squared Error ( ğ‘€ğ‘†ğ¸ ) as the
evaluation metric. The smaller ğœ–ğ´ğ‘‡ğ¸ andğ‘€ğ‘†ğ¸ are, the better
the performance.
5.3 Results
5.3.1 Comparison with the SOTA methods. Binary Scenario: Table
1 shows the performance of ğ‘†ğ·2on datasets with binary values. ğ‘šğ‘£-
ğ‘šğ‘§-ğ‘šğ‘-ğ‘šğ‘-ğ‘šğ‘¢represents the data generated with ğ‘šğ‘£predefined
IVsğ‘‰,ğ‘šğ‘§underlying IVs ğ‘,ğ‘šğ‘underlying confounders ğ¶,ğ‘šğ‘
underlying adjustable variables ğ´andğ‘šğ‘¢unobserved confounders
ğ‘ˆ. During training, we can only observe ğ‘,ğ¶andğ´as a wholeğ‘‹.
Twins-ğ‘šğ‘£-ğ‘šğ‘¥-ğ‘šğ‘¢denotes the Twins dataset with ğ‘šğ‘£predefined
IVs,ğ‘šğ‘¥observed pre-treatment covariates and ğ‘šğ‘¢unobserved
confounders and IVs. For data setting with ğ‘šğ‘¥=16(Twins-0-16-8,
Twins-4-16-8, Twins-0-16-12), there are 12 confounders and IVs, 4
adjustable variables and noises, while for Twins-0-20-8, we add 4
confounders and IVs in ğ‘‹.
We generate 10000 samples for synthetic datasets for training,
validation and testing sets, respectively, For the Twins datasets,
we randomly choose 5271 samples and split the datasets with the
ratio 63/27/10. We perform 10 replications and report the mean and
standard deviation of the bias of ATE estimation. Taking the results
in 0-4-4-2-2 as a base point for observation, we have the following
findings:
 
1671KDD â€™24, August 25â€“29, 2024, Barcelona, Spain Xinshu Li, Mingming Gong, and Lina Yao
Table 1: Performance comparison of bias of ATE between ğ‘‰ğ‘†ğ·2and the SOTA baselines on the synthetic datasets ( ğ‘šğ‘£-ğ‘šğ‘§-ğ‘šğ‘-ğ‘šğ‘-
ğ‘šğ‘¢) and Twins datasets (Twins- ğ‘šğ‘£-ğ‘šğ‘¥-ğ‘šğ‘¢). Bold/Underline indicates the method with the best/second best performance.
Within-Sample Out-of-Sample
Method 0-4-4-2-2 2-4-4-2-2 0-4-4-2-10 0-6-2-2-2 0-4-4-2-2 2-4-4-2-2 0-4-4-2-10 0-6-2-2-2
DirectRep 0.037(0.023) 0.034(0.009) 0.060(0.014) 0.043(0.025) 0.034(0.024) 0.034(0.013) 0.060(0.015) 0.037(0.024)
CFR 0.031(0.014) 0.032(0.017) 0.056(0.017) 0.060(0.019) 0.027(0.016) 0.032(0.021) 0.031(0.024) 0.054(0.018)
DRCFR 0.058(0.018) 0.050(0.025) 0.071(0.020) 0.066(0.015) 0.053(0.016) 0.050(0.023) 0.071(0.020) 0.059(0.018)
DFL 3.696(0.034) 3.702(0.045) 4.055(0.041) 3.450(0.030) 6.796(0.056) 6.750(0.086) 7.398(0.051) 6.393(0.063)
DeepIV-Log 0.569(0.024) 0.567(0.011) 0.601(0.011) 0.531(0.019) 0.572(0.028) 0.567(0.016) 0.601(0.011) 0.537(0.021)
DeepIV-Gmm 0.466(0.012) 0.387(0.021) 0.518(0.012) 0.437(0.007) 0.469(0.008) 0.387(0.021) 0.517(0.009) 0.442(0.004)
DFIV 3.947(0.108) 3.810(0.041) 4.400(0.134) 3.644(0.103) 7.047(0.131) 6.856(0.093) 7.749(0.125) 6.585(0.130)
OneSIV 0.504(0.008) 0.441(0.063) 0.569(0.013) 0.478(0.012) 0.507(0.009) 0.441(0.064) 0.569(0.015) 0.484(0.014)
CBIV 0.063(0.025) 0.065(0.032) 0.049(0.022) 0.033(0.023) 0.059(0.024) 0.067(0.030) 0.049(0.023) 0.030(0.017)
Ours 0.010(0.008) 0.017(0.013) 0.029(0.019) 0.014(0.013) 0.012(0.008) 0.022(0.017) 0.029(0.018) 0.013(0.010)
Within-Sample Out-of-Sample
Method Twins-0-16-8 Twins-4-16-8 Twins-0-16-12 Twins-0-20-8 Twins-0-16-8 Twins-4-16-8 Twins-0-16-12 Twins-0-20-8
DirectRep 0.015(0.007) 0.009(0.008) 0.018(0.012) 0.012(0.007) 0.023(0.011) 0.014(0.013) 0.023(0.016) 0.014(0.010)
CFR 0.011(0.010) 0.012(0.008) 0.017(0.014) 0.010(0.011) 0.016(0.008) 0.019(0.010) 0.025(0.019) 0.019(0.014)
DRCFR 0.015(0.016) 0.008(0.005) 0.016(0.017) 0.024(0.017) 0.020(0.019) 0.018(0.007) 0.020(0.009) 0.028(0.018)
DFL 0.173(0.018) 0.181(0.014) 0.169(0.020) 0.175(0.019) 0.243(0.136) 0.252(0.140) 0.240(0.141) 0.245(0.145)
DeepIV-Log 0.019(0.010) 0.017(0.016) 0.022(0.011) 0.012(0.007) 0.028(0.016) 0.026(0.019) 0.028(0.018) 0.018(0.011)
DeepIV-Gmm 0.022(0.004) 0.016(0.004) 0.022(0.003) 0.018(0.004) 0.017(0.011) 0.013(0.009) 0.017(0.011) 0.013(0.011)
DFIV 0.186(0.014) 0.185(0.015) 0.186(0.014) 0.163(0.023) 0.257(0.145) 0.255(0.148) 0.256(0.144) 0.227(0.151)
OneSIV 0.015(0.011) 0.008(0.005) 0.030(0.017) 0.017(0.006) 0.016(0.014) 0.011(0.007) 0.025(0.020) 0.013(0.010)
CBIV 0.024(0.016) 0.057(0.012) 0.051(0.038) 0.037(0.019) 0.033(0.016) 0.063(0.017) 0.057(0.039) 0.043(0.022)
Ours 0.008(0.006) 0.007(0.004) 0.007(0.006) 0.008(0.006) 0.012(0.007) 0.011(0.006) 0.012(0.006) 0.011(0.009)
Figure 4: Experimental results under continuous scenario on Demand-0-1. Among all methods, ğ‘‰ğ‘†ğ·2achieves the best and
most stable results.
â€¢The results of almost all IV-based methods in 0-4-4-2-2 are
worse than those in 2-4-4-2-2, demonstrating the perfor-
mance of IV-based methods is highly dependent on the pre-
defined instrumental variables.
â€¢By comparing the results between 0-4-4-2-2 and 0-4-4-2-10,
we find that when there are more unobserved confounders
in the dataset, the performance of confounder balancing
methods (such as CFR, DRCFR, and DFL) will be poorer,which indicates the necessity of controlling the unobserved
confounders.
â€¢If there are fewer confounders in observed features, as we
compare 0-4-4-2-2 with 0-2-6-2-2, the performance of con-
founder balancing methods without disentanglement (such
as CFR, DFL) gets impeded, implying the significance of pre-
cise confounder control by decomposing underlying factors.
â€¢ğ‘†ğ·2achieves the best performance among all data settings
and is far better than the second-best methods. It proves
 
1672Self-Distilled Disentangled Learning for Counterfactual Prediction KDD â€™24, August 25â€“29, 2024, Barcelona, Spain
Table 2: Performance comparison of MSE between ğ‘†ğ·2and
the SOTA baselines on the Demands datasets (Demands- ğ›¼-ğ›½).
Bold/Underline indicates the method with the best/second-
best performance.
Within-Sample
Method Demands-0-1 Demands-0-5 Demands-5-1
DirectRep 472.14(292.68) 319.27(156.58) 795.38(304.10)
CFR 1180.26(439.56) 340.12(175.82) 1891.91(79.78)
DFL 786.92(122.35) 1074.71(142.78) 874.78(103.71)
DRCFR 720.51(195.09) 451.31(407.55) 809.04(94.98)
DEVAE >10000 >10000 >10000
DeepIV-Gmm 1774.71(757.98) 3429.79(438.65) 2618.72(775.20)
DFIV 862.00(123.71) 1420.24(257.10) 909.25(137.05)
OneSIV 2573.15(157.31) >10000 2352.69(125.16)
CBIV 819.52(535.05) 410.42(241.71) 2542.58(442.26)
Ours 170.55(6.51) 216.55(47.11) 171.07(6.41)
Out-of-Sample
Method Demands-0-1 Demands-0-5 Demands-5-1
DirectRep 494.47(287.92) 303.22(144.85) 768.15(278.24)
CFR 1103.00(362.45) 326.54(110.31) 1877.60(119.71)
DFL 736.35(123.44) 914.08(90.11) 822.71(65.88)
DRCFR 766.22(188.86) 498.22(363.25) 864.21(83.39)
DEVAE >10000 >10000 >10000
DeepIV-Gmm 904.60(618.41) 2423.33(326.23) 2405.33(675.40)
DFIV 943.57(188.70) 1213.27(388.08) 1050.65(253.38)
OneSIV 2744.87(182.35) 4243.51(596.10) 2538.77(147.29)
CBIV 2990.19(735.92) 316.66(114.89) 2958.70(614.26)
Ours 183.21(14.18) 199.44(14.60) 187.20(16.05)
counterfactual prediction benefits from simultaneously con-
trolling the underlying confounders in observational features
and unobserved confounders. The effectiveness of our dis-
entanglement theory and hierarchical self-distillation frame-
work is thus validated. The results in all Twins datasets are
consistent with these findings.
Continuous Scenario: Following Wu et al . [39] , we use Demand-
ğ›¼-ğ›½to denote different data setting in Demands datasets. Demand-
0-1 represents the original Demand dataset defined in Hartford
et al. [14] . Theğ›¼in Demand- ğ›¼-ğ›½denotes the extra information
from instrumental variables while the ğ›½indicates the information
increasing from instrumental variables and underlying confounders
together on the basis of Demand-0-1. We only present the results
on Demand-0-1 with box plots as shown in Figure 4, where we omit
the results of CEVAE as its ğ‘€ğ‘†ğ¸ is beyond 10000.
The IV-based methods perform worse than the non-IV-based
ones under the continuous scenario. This result indicates that con-
founding bias from the treatment regression stage is a critical prob-
lem in IV-based methods, underscoring the necessity of decompos-
ingğ¶from observed variables and thereby correcting for confound-
ing bias caused by ğ¶, coinciding with the findings under the binary
scenario. We notice that DRCFR, which performs well on discrete
datasets, suffers significantly on the Demand-0-1, reflecting the
limitations of their disentanglement theory under the continuous
(a)Identification of Z with ğ‘‰ğ‘†ğ·2
(b)Identification of Z with DRCFR
(c)Identification of C with ğ‘‰ğ‘†ğ·2
(d)Identification of C with DRCFR
(e)Identification of A with ğ‘‰ğ‘†ğ·2
(f)Identification of A with DRCFR
Figure 5: Radar charts that visualize the capability of ğ‘‰ğ‘†ğ·2
and a classical causal disentangled learning baseline DR-
CFR. Every vertex on the polygons represents a synthetic
dataset with setting ğ‘šğ‘£-ğ‘šğ‘§-ğ‘šğ‘-ğ‘šğ‘-ğ‘šğ‘¢. The red and blue de-
note the contribution of true variables and other variables
to the decomposed representations. The results demonstrate
our method achieves much better identification performance
of all three underlying factors in all synthetic datasets com-
pared with DRCFR.
scenario. Among all the baselines, ğ‘†ğ·2achieves the best and most
stable performance on all Demands Datasets, demonstrating the
generalizability ofğ‘†ğ·2on various types of datasets.
The detailed experimental results on all Demands datasets are
provided in the Table 2. It can be seen that whether adding the
information of instrumental variables (Demands-5-1) or increasing
the information of confounders (Demands-0-5), our algorithm per-
forms far better than all the baseline, which proves the efficiency
andgeneralizability of our method.
5.3.2 Disentanglement Visualization. To check ifğ‘‰ğ‘†ğ·2decompose
different kinds of underlying factors from pre-treatment variables
successfully, similar to Hassanpour and Greiner [15], we use the
 
1673KDD â€™24, August 25â€“29, 2024, Barcelona, Spain Xinshu Li, Mingming Gong, and Lina Yao
Within-Sample 0-4-4-2-2 2-4-4-2-2 0-4-4-2-10 0-6-2-2-2 Twins-0-16-8 Twins-4-16-8 Twins-0-16-12 Twins-0-20-8
CLUB 0.514(0.005) 0.513(0.006) 0.563(0.006) 0.481(0.006) 0.020(0.009) 0.029(0.008) 0.024(0.007) 0.023(0.005)
Ours 0.010(0.008) 0.017(0.013) 0.029(0.019) 0.014(0.013) 0.008(0.006) 0.007(0.004) 0.007(0.006) 0.008(0.006)
Out-of-Sample 0-4-4-2-2 2-4-4-2-2 0-4-4-2-10 0-6-2-2-2 Twins-0-16-8 Twins-4-16-8 Twins-0-16-12 Twins-0-20-8
CLUB 0.517(0.004) 0.513(0.006) 0.563(0.004) 0.487(0.005) 0.016(0.013) 0.026(0.009) 0.021(0.012) 0.018(0.010)
Ours 0.012(0.008) 0.022(0.017) 0.029(0.018) 0.013(0.010) 0.012(0.007) 0.011(0.006) 0.012(0.006) 0.011(0.009)
Table 3: Performance comparison of bias of ATE between ğ‘†ğ·2and a method which replaces the disentanglement modules in
ğ‘†ğ·2with one of the SOTA mutual information estimators ğ¶ğ¿ğ‘ˆğµ .
DatasetsWithin-Sample Out-of-Sample
ğ¿ğ‘ğ¿ğ‘+ğ¿ğ‘¡ğ¿ğ‘+ğ¿ğ‘¡+ğ¿ğ‘ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™ ğ¿ ğ‘ğ¿ğ‘+ğ¿ğ‘¡ğ¿ğ‘+ğ¿ğ‘¡+ğ¿ğ‘ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™
Twins-0-16-8 0.027(0.012) 0.025(0.007) 0.021(0.007) 0.008(0.006) 0.022(0.011) 0.020(0.011) 0.018(0.010) 0.012(0.007)
Twins-4-16-8 0.067(0.078) 0.022(0.005) 0.024(0.005) 0.008(0.005) 0.059(0.076) 0.017(0.012) 0.019(0.012) 0.009(0.006)
Twins-0-16-12 0.113(0.110) 0.027(0.005) 0.024(0.005) 0.007(0.006) 0.111(0.109) 0.022(0.011) 0.019(0.012) 0.012(0.006)
Twins-0-20-8 0.031(0.010) 0.020(0.004) 0.023(0.006) 0.008(0.006) 0.026(0.013) 0.015(0.009) 0.018(0.012) 0.011(0.009)
Syn-0-4-4-2-2 0.519(0.005) 0.513(0.005) 0.513(0.004) 0.010(0.008) 0.522(0.004) 0.517(0.004) 0.516(0.004) 0.012(0.008)
Syn-2-4-4-2-2 0.517(0.007) 0.513(0.007) 0.513(0.007) 0.017(0.013) 0.517(0.006) 0.512(0.007) 0.513(0.006) 0.022(0.017)
Syn-0-4-4-2-10 0.569(0.005) 0.565(0.004) 0.565(0.005) 0.029(0.019) 0.568(0.004) 0.565(0.004) 0.564(0.004) 0.029(0.018)
Syn-0-6-2-2-2 0.486(0.004) 0.483(0.004) 0.483(0.004) 0.015(0.013) 0.492(0.005) 0.489(0.005) 0.489(0.005) 0.013(0.010)
Table 4: Ablation Study. ğ¿ğ‘represents preserving representation networks and deep outcome classifier only. ğ¿ğ‘+ğ¿ğ‘¡adds deep
treatment classifier on the basis of the model of ğ¿ğ‘.ğ¿ğ‘+ğ¿ğ‘¡+ğ¿ğ‘adds the adjustable variable decomposition module on the basis
of the model of ğ¿ğ‘+ğ¿ğ‘¡.ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™ model is our proposed model.
first (second) slice to denote the weight matrix that connects the
variables in X belonging (not belonging) to the actual variables.
The polygonsâ€™ radii in Figure 5 quantify the average weights of
the first slice (in red) and the second slice (in blue). We plot the
radar charts to visualize the contribution of actual variables to the
representations of each factor on ğ‘†ğ·2and another typical causal
disentangled learning work DRCFR.
As shown in each sub-figure in Figure 5, each vertex on the poly-
gon represents the results of a synthetic dataset ğ‘šğ‘£-ğ‘šğ‘§-ğ‘šğ‘-ğ‘šğ‘-ğ‘šğ‘¢.
Compared with DRCFR, our method realizes much better identifi-
cation performance of all three underlying factors in all datasets,
indicating that our approach can achieve successful disentangle-
ment performance.
5.3.3 Difficulty of mutual information estimation. To quantify the
difficulty of high-dimensional mutual information estimation, we
substitute our core disentanglement module with one of the state-
of-the-art mutual information estimators, CLUB [ 9], which has been
widely adopted in previous causal disentangled learning methods
[8,41,45], aiming to directly minimize the mutual information
betweenğ‘…ğ‘§,ğ‘…ğ‘, andğ‘…ğ‘. The related experimental results ( ğ¶ğ¿ğ‘ˆğµ in
Table 3) show that the performance of our method gets impeded
dramatically, indicating the importance of bypassing the complex
mutual information estimation.
5.3.4 Ablation Study. We perform the ablation experiments to ex-
amine the contributions of each component in total loss function on
final inference performance. The results are shown in Table 4. We
conduct following steps for the ablation study analysis: Firstly, weonly preserve representation networks and deep outcome predic-
tion networks. The objective loss is reduced to factual loss ğ¿ğ‘plus
regularization loss. Secondly, we add the deep treatment predic-
tion networks into the model on the basis of the first model, while
the objective loss becomes ğ¿ğ‘+ğ¿ğ‘¡. Then, the adjustable variables
decomposition module is integrated into the second model, thus
the objective loss is ğ¿ğ‘+ğ¿ğ‘¡+ğ¿ğ‘. Finally, we introduce our shallow
treatment and outcome prediction networks into the third model,
the objective loss of which is presented in Eq (11)in the main paper
and named as ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™ .
We have the following observations from the experimental re-
sults in Table 4:
â€¢The model with loss function ğ¿ğ‘performs the worst for all
data settings on all datasets, demonstrating the significance
of treatment prediction for counterfactual prediction in the
presence of unobserved confounders.
â€¢If we only decompose adjustable variables ğ´from observed
featuresğ‘‹, as the results under the loss ğ¿ğ‘+ğ¿ğ‘¡+ğ¿ğ‘shows,
the model indeed does not get much improvement on the
inference performance compared with the results under the
lossğ¿ğ‘+ğ¿ğ‘¡. This may be due to the fact that only decompos-
ing A cannot eliminate the confounding bias caused by the
unmeasured confounders ğ‘ˆand underlying confounders ğ¶
existing in observed features ğ‘‹. In addition, it indicates the
necessity of the decomposition of ğ¶andğ‘for counterfactual
prediction.
â€¢When added shallow prediction networks of treatment and
outcome during training, as the results of ğ‘‡ğ‘œğ‘¡ğ‘ğ‘™ model show,
 
1674Self-Distilled Disentangled Learning for Counterfactual Prediction KDD â€™24, August 25â€“29, 2024, Barcelona, Spain
(a)
 (b)
 (c)
 (d)
Figure 6: Hyper-parameters sensitivity analysis of ğ›¼,ğ›½,ğ›¾,ğ›¿ on Syn-0-4-4-2-2 dataset. The blue and red lines show the ATE results
of these parameters in within-sample and out-of-sample settings, respectively. The blue circle and red star represent the best
parameters for the setting.
Figure 7: Scalability Analysis. The performance of ğ‘†ğ·2remains stable and efficient with the variation of sample size in the
dataset compared with ğ·ğ‘…ğ¶ğ¹ğ‘… , indicating the scalability of ğ‘†ğ·2.
ourğ‘†ğ·2achieves the best performance with the improve-
ment of more than 60%on Synthetic datasets and over 95%
on Twins datasets on the basis of the model under the loss
ğ¿ğ‘+ğ¿ğ‘¡+ğ¿ğ‘, which demonstrates the decomposition of ğ¶
andğ‘indeed advances the counterfactual inference.
5.3.5 Hyper-Parameters Analysis. With the multi-term total loss
function shown in Eq (11), we study the impact of each item on
the counterfactual prediction on Syn-0-4-4-2-2 dataset. As can be
seen from Figure 6(c), the performance of ğ‘†ğ·2is mostly affected by
the changing in ğ›¾. In addition, although the performance fluctuates
with the change of ğ›¼andğ›½,ğ‘†ğ·2performs better than almost all
baselines. These two facts demonstrate that the improvement of
inference performance is greatly contributed by the decomposition
ofğ‘andğ¶. Besides, from Figure 6(d), we find that the performance
of the method is affected by changing ğ›¿as well, indicating the
necessity of limiting the complexity of the model.
5.3.6 Scalability Analysis. To demonstrate the scalability of our
algorithm, we conduct experiments on Syn-0-4-4-2-2 with different
sample sizes with our method and DRCFR [ 15]. Figure 7 shows the
results of the related experimental results. It can be seen from the
results that the performance of ğ‘†ğ·2remains stable and efficient
with the variation of sample size in the dataset, which demonstrates
thescalability of our algorithm.6 CONCLUSION AND LIMITATIONS
To resolve the challenge of decomposing mutually independent
underlying factors in causal disentangled learning study, we pro-
vide a theoretically guaranteed solution to minimizing the mutual
information between representations of diverse underlying factors
instead of relying on explicit estimation. On this basis, we design a
hierarchical self-distilled disentanglement framework ğ‘†ğ·2to ad-
vance counterfactual prediction by eliminating the confounding
bias caused by the observed and unobserved confounders simulta-
neously. Extensive experimental results on synthetic and real-world
datasets validate the effectiveness, generalizability, scalability of
our proposed theory and framework in both binary and continuous
data settings.
Limitations: Due to the lack of real-world counterfactual datasets,
ğ‘†ğ·2is only evaluated on limited tasks. It would be interesting to
extend our method into other research areas, such as transfer learn-
ing [ 31], domain adaptation [ 26], counterfactual fairness [ 20], for
robust feature extraction. We will leave future work for the gener-
alization of our method to these fields.
7 ACKNOWLEDGEMENTS
We thank anonymous reviewers for their insightful comments and
discussions. Mingming Gong was supported by ARC DE210101624
and DP240102088.
 
1675KDD â€™24, August 25â€“29, 2024, Barcelona, Spain Xinshu Li, Mingming Gong, and Lina Yao
REFERENCES
[1]Ahmed M Alaa and Mihaela van der Schaar. 2017. Bayesian inference of indi-
vidualized treatment effects using multi-task gaussian processes. Advances in
Neural Information Processing Systems 30 (2017).
[2]Douglas Almond, Kenneth Y Chay, and David S Lee. 2005. The costs of low birth
weight. The Quarterly Journal of Economics 120, 3 (2005), 1031â€“1083.
[3]Joshua David Angrist and Guido Imbens. 1994. Identification and Estimation of
Local Average Treatment Effects. NBER Working Paper Series (1994).
[4]Joshua D Angrist, Guido W Imbens, and Donald B Rubin. 1996. Identification of
causal effects using instrumental variables. Journal of the American statistical
Association 91, 434 (1996), 444â€“455.
[5]Mohamed Ishmael Belghazi, Aristide Baratin, Sai Rajeshwar, Sherjil Ozair, Yoshua
Bengio, Aaron Courville, and Devon Hjelm. 2018. Mutual information neural
estimation. In International conference on machine learning. PMLR, 531â€“540.
[6]Xi Chen, Yan Duan, Rein Houthooft, John Schulman, Ilya Sutskever, and P. Abbeel.
2016. InfoGAN: Interpretable Representation Learning by Information Maximiz-
ing Generative Adversarial Nets. In NIPS.
[7]Lu Cheng, Ruocheng Guo, Kasim Candan, and Huan Liu. 2022. Effects of Multi-
Aspect Online Reviews with Unobserved Confounders: Estimation and Implica-
tion. In Proceedings of the International AAAI Conference on Web and Social Media,
Vol. 16. 67â€“78.
[8]Mingyuan Cheng, Xinru Liao, Quan Liu, Bin Ma, Jian Xu, and Bo Zheng. 2022.
Learning disentangled representations for counterfactual regression via mutual
information minimization. In Proceedings of the 45th International ACM SIGIR
Conference on Research and Development in Information Retrieval. 1802â€“1806.
[9]Pengyu Cheng, Weituo Hao, Shuyang Dai, Jiachang Liu, Zhe Gan, and Lawrence
Carin. 2020. CLUB: A Contrastive Log-ratio Upper Bound of Mutual Information.
InInternational Conference on Machine Learning.
[10] Victor Chernozhukov, IvÃ¡n FernÃ¡ndez-Val, and Blaise Melly. 2013. Inference on
counterfactual distributions. Econometrica 81, 6 (2013), 2205â€“2268.
[11] Hugh A Chipman, Edward I George, and Robert E McCulloch. 2010. BART:
Bayesian additive regression trees. The Annals of Applied Statistics 4, 1 (2010),
266â€“298.
[12] Thomas A Glass, Steven N Goodman, Miguel A HernÃ¡n, and Jonathan M Samet.
2013. Causal inference in public health. Annual review of public health 34 (2013),
61.
[13] Ian J. Goodfellow, Jean Pouget-Abadie, Mehdi Mirza, Bing Xu, David Warde-
Farley, Sherjil Ozair, Aaron C. Courville, and Yoshua Bengio. 2014. Generative
Adversarial Nets. In NIPS.
[14] Jason Hartford, Greg Lewis, Kevin Leyton-Brown, and Matt Taddy. 2017. Deep
IV: A flexible approach for counterfactual prediction. In International Conference
on Machine Learning. PMLR, 1414â€“1423.
[15] Negar Hassanpour and Russell Greiner. 2019. Learning disentangled represen-
tations for counterfactual regression. In International Conference on Learning
Representations.
[16] Irina Higgins, Loic Matthey, Arka Pal, Christopher Burgess, Xavier Glorot,
Matthew Botvinick, Shakir Mohamed, and Alexander Lerchner. 2017. beta-VAE:
Learning Basic Visual Concepts with a Constrained Variational Framework. In
International Conference on Learning Representations. https://openreview.net/
forum?id=Sy2fzU9gl
[17] Caroline M Hoxby. 2000. Does competition among public schools benefit students
and taxpayers? American Economic Review 90, 5 (2000), 1209â€“1238.
[18] Guido W Imbens. 2004. Nonparametric estimation of average treatment effects
under exogeneity: A review. Review of Economics and statistics 86, 1 (2004), 4â€“29.
[19] Hyunjik Kim and Andriy Mnih. 2018. Disentangling by Factorising. In Interna-
tional Conference on Machine Learning.
[20] Hyemi Kim, Seungjae Shin, Joonho Jang, Kyungwoo Song, Weonyoung Joo,
Wanmo Kang, and Il-Chul Moon. 2020. Counterfactual Fairness with Disentangled
Causal Effect Variational Autoencoder. ArXiv abs/2011.11878 (2020).
[21] Diederik P. Kingma and Max Welling. 2013. Auto-Encoding Variational Bayes.
CoRR abs/1312.6114 (2013).
[22] Xinshu Li and Lina Yao. 2022. Contrastive Individual Treatment Effects Estimation.
In2022 IEEE International Conference on Data Mining (ICDM). 1053â€“1058. https:
//doi.org/10.1109/ICDM54844.2022.00130
[23] Xinshu Li and Lina Yao. 2024. Distribution-Conditioned Adversarial Variational
Autoencoder for Valid Instrumental Variable Generation. In Proceedings of the
AAAI Conference on Artificial Intelligence, Vol. 38. 13664â€“13672.
[24] Adi Lin, Jie Lu, Junyu Xuan, Fujin Zhu, and Guangquan Zhang. 2019. One-stage
deep instrumental variable method for causal inference from observational data.
In2019 IEEE International Conference on Data Mining (ICDM). IEEE, 419â€“428.
[25] Christos Louizos, Uri Shalit, Joris M. Mooij, David A. Sontag, Richard S. Zemel,
and Max Welling. 2017. Causal Effect Inference with Deep Latent-Variable Models.
InNIPS.[26] Sara Magliacane, Thijs van Ommen, Tom Claassen, Stephan Bongers, Philip
Versteeg, and Joris M. Mooij. 2017. Domain Adaptation by Using Causal Inference
to Predict Invariant Conditional Distributions. In Neural Information Processing
Systems.
[27] Krikamol Muandet, Arash Mehrjou, Si Kai Lee, and Anant Raj. 2020. Dual
instrumental variable regression. Advances in Neural Information Processing
Systems 33 (2020), 2710â€“2721.
[28] Judea Pearl et al .2000. Models, reasoning and inference. Cambridge, UK: Cam-
bridgeUniversityPress 19 (2000), 2.
[29] Ben Poole, Sherjil Ozair, Aaron Van Den Oord, Alex Alemi, and George Tucker.
2019. On variational bounds of mutual information. In International Conference
on Machine Learning. PMLR, 5171â€“5180.
[30] Aahlad Puli and Rajesh Ranganath. 2020. General Control Functions for Causal
Effect Estimation from IVs. Advances in neural information processing systems 33
(2020), 8440â€“8451.
[31] Mateo Rojas-Carulla, Bernhard SchÃ¶lkopf, Richard E. Turner, and J. Peters. 2015.
Invariant Models for Causal Transfer Learning. J. Mach. Learn. Res. 19 (2015),
36:1â€“36:34.
[32] Paul R Rosenbaum and Donald B Rubin. 1983. The central role of the propensity
score in observational studies for causal effects. Biometrika 70, 1 (1983), 41â€“55.
[33] Uri Shalit, Fredrik D Johansson, and David Sontag. 2017. Estimating individual
treatment effect: generalization bounds and algorithms. In International Confer-
ence on Machine Learning. PMLR, 3076â€“3085.
[34] Rahul Singh, Maneesh Sahani, and Arthur Gretton. 2019. Kernel instrumental
variable regression. Advances in Neural Information Processing Systems 32 (2019).
[35] Victor Veitch, Dhanya Sridhar, and David Blei. 2020. Adapting text embeddings
for causal inference. In Conference on Uncertainty in Artificial Intelligence. PMLR,
919â€“928.
[36] Victor Veitch, Yixin Wang, and David Blei. 2019. Using embeddings to correct for
unobserved confounding in networks. Advances in Neural Information Processing
Systems 32 (2019).
[37] Yixin Wang and David M Blei. 2019. The blessings of multiple causes. J. Amer.
Statist. Assoc. 114, 528 (2019), 1574â€“1596.
[38] Jeffrey M. Wooldridge. 2015. Control Function Methods in Applied Econometrics.
Journal of Human Resources 50, 2 (2015), 420â€“445. https://doi.org/10.3368/jhr.50.
2.420 arXiv:https://jhr.uwpress.org/content/50/2/420.full.pdf
[39] Anpeng Wu, Kun Kuang, Bo Li, and Fei Wu. 2022. Instrumental variable regres-
sion with confounder balancing. In International Conference on Machine Learning.
PMLR, 24056â€“24075.
[40] Anpeng Wu, Kun Kuang, Ruoxuan Xiong, Minqing Zhu, Yuxuan Liu, Bo Li,
Furui Liu, Zhihua Wang, and Fei Wu. 2022. Treatment Effect Estimation with
Unmeasured Confounders in Data Fusion. ArXiv abs/2208.10912 (2022).
[41] Anpeng Wu, Kun Kuang, Junkun Yuan, Bo Li, Runze Wu, Qiang Zhu, Yueting
Zhuang, and Fei Wu. 2020. Learning decomposed representation for counterfac-
tual inference. arXiv preprint arXiv:2006.07040 (2020).
[42] Pengzhou Abel Wu and Kenji Fukumizu. 2022. $\beta$-Intact-VAE: Identifying
and Estimating Causal Effects under Limited Overlap. In International Conference
on Learning Representations. https://openreview.net/forum?id=q7n2RngwOM
[43] Liyuan Xu, Yutian Chen, Siddarth Srinivasan, Nando de Freitas, Arnaud Doucet,
and Arthur Gretton. 2020. Learning deep features in instrumental variable
regression. arXiv preprint arXiv:2010.07154 (2020).
[44] Liuyi Yao, Sheng Li, Yaliang Li, Mengdi Huai, Jing Gao, and Aidong Zhang. 2018.
Representation learning for treatment effect estimation from observational data.
Advances in Neural Information Processing Systems 31 (2018).
[45] Junkun Yuan, Anpeng Wu, Kun Kuang, Bo Li, Runze Wu, Fei Wu, and Lanfen Lin.
2022. Auto IV: Counterfactual Prediction via Automatic Instrumental Variable
Decomposition. ACM Transactions on Knowledge Discovery from Data (TKDD)
16, 4 (2022), 1â€“20.
[46] Linying Zhang, Yixin Wang, Anna Ostropolets, Jami J Mulgrave, David M Blei, and
George Hripcsak. 2019. The medical deconfounder: assessing treatment effects
with electronic health records. In Machine Learning for Healthcare Conference.
PMLR, 490â€“512.
[47] Weijia Zhang, Lin Liu, and Jiuyong Li. 2021. Treatment effect estimation with
disentangled latent factors. In Proceedings of the AAAI Conference on Artificial
Intelligence, Vol. 35. 10923â€“10930.
[48] Guanglin Zhou, Shaoan Xie, Guangyuan Hao, Shiming Chen, Biwei Huang, Xiwei
Xu, Chen Wang, Liming Zhu, Lina Yao, and Kun Zhang. 2023. Emerging synergies
in causality and deep generative models: A survey. arXiv preprint arXiv:2301.12351
(2023).
[49] Guanglin Zhou, Lina Yao, Xiwei Xu, Chen Wang, and Liming Zhu. 2022. Cycle-
Balanced Representation Learning For Counterfactual Inference. In Proceedings
of the 2022 SIAM International Conference on Data Mining (SDM). SIAM, 442â€“450.
[50] Yang Zou, Xiaodong Yang, Zhiding Yu, B. V. K. Vijaya Kumar, and Jan Kautz. 2020.
Joint Disentangling and Adaptation for Cross-Domain Person Re-Identification.
ArXiv abs/2007.10315 (2020).
 
1676Self-Distilled Disentangled Learning for Counterfactual Prediction KDD â€™24, August 25â€“29, 2024, Barcelona, Spain
A APPENDIX
A.1 Theoretical Proof
A.1.1 Proof of Theorem 4.1. Considerğ‘…ğ‘andğ‘…ğ‘as the representa-
tions ofğ´andğ¶produced by the representation networks, and let
Y be the label of the outcome. We have,
minğ¼(ğ‘Œ;ğ‘…ğ‘)âˆ’ğ¼(ğ‘…ğ‘;ğ‘Œ|ğ‘…ğ‘)â‡â‡’
minğ»(ğ‘Œ)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)+ğ»(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘).
Proof. Based on the definition of mutual information [5]:
ğ¼(ğ‘Œ;ğ‘…ğ‘)=ğ»(ğ‘Œ)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘), (15)
whereğ»(ğ‘Œ)denotes Shannon entropy, and ğ»(ğ‘Œ|ğ‘…ğ‘)is the condi-
tional entropy of ğ‘Œgivenğ‘…ğ‘. Similarly,
ğ¼(ğ‘…ğ‘;ğ‘Œ|ğ‘…ğ‘)=ğ»(ğ‘Œ|ğ‘…ğ‘)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘), (16)
whereğ¼(ğ‘…ğ‘;ğ‘Œ|ğ‘…ğ‘)denotes the conditional mutual information
betweenğ‘…ğ‘andğ‘Œgivenğ‘…ğ‘;ğ»(ğ‘Œ|ğ‘…ğ‘)andğ»(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)is the the
conditional entropy of ğ‘Œgivenğ‘…ğ‘,ğ‘…ğ‘andğ‘…ğ‘, respectively.
Combining Eq (15) and Eq (16), we have Theo.4.1 holds. â–¡
A.1.2 Proof of Corollary 4.2. One of sufficient conditions of mini-
mizingğ¼(ğ‘…ğ‘;ğ‘…ğ‘)is:
min(
ğ·ğ¾ğ¿[Pğ‘Œâˆ¥Pğ‘…ğ‘
ğ‘Œ]
ğ·ğ¾ğ¿[Pğ‘…ğ‘
ğ‘Œâˆ¥Pğ‘…ğ‘
ğ‘Œ],
wherePğ‘…ğ‘
ğ‘Œ=ğ‘(ğ‘Œ|ğ‘…ğ‘),Pğ‘…ğ‘
ğ‘Œ=ğ‘(ğ‘Œ|ğ‘…ğ‘)represent the predicted
distributions,Pğ‘Œ=ğ‘(ğ‘Œ)represents the real distribution, and ğ·ğ¾ğ¿
denotes the KL-divergence.
Proof. Based on the definition of conditional entropy, for any
continuous variables ğ‘…ğ‘,ğ‘…ğ‘andğ‘Œ, we have:
ğ»(ğ‘Œ)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)+ğ»(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)=
âˆ’âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ)ğ‘‘ğ‘Œ
+âˆ«
ğ‘(ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘âˆ«
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œ
|                                                 {z                                                 }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ¶
+âˆ«
ğ‘(ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘âˆ«
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œ
|                                                  {z                                                  }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ´
âˆ’âˆ¬
ğ‘(ğ‘…ğ‘,ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘…ğ‘âˆ«
ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)ğ‘‘ğ‘Œ
|                                                                       {z                                                                       }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ‘€.(18)
We further inspect ğ‘¡ğ‘’ğ‘Ÿğ‘šğ¶ in Eq (18) and have:âˆ«
ğ‘(ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘âˆ«
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œ=
âˆ¬
ğ‘(ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ.(19)By factorizing the double integrals in Eq (19)into another two
components, we show the following:
âˆ¬
ğ‘(ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ=
âˆ¬
ğ‘(ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
|                                              {z                                              }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ¶ 1+
âˆ¬
ğ‘(ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
|                                              {z                                              }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ¶ 2.(20)
Conduct similar factorization for ğ‘¡ğ‘’ğ‘Ÿğ‘šğ´ andğ‘¡ğ‘’ğ‘Ÿğ‘šğ‘€ in Eq (18), we
have:âˆ«
ğ‘(ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘âˆ«
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œ=
âˆ¬
ğ‘(ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
|                                               {z                                               }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ´ 1+
âˆ¬
ğ‘(ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
|                                              {z                                              }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ´ 2(21)
âˆ¬
ğ‘(ğ‘…ğ‘,ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘…ğ‘âˆ«
ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)ğ‘‘ğ‘Œ=
âˆ­
ğ‘(ğ‘…ğ‘,ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)
ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
|                                                                    {z                                                                    }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ‘€ 1+
âˆ­
ğ‘(ğ‘…ğ‘,ğ‘…ğ‘)ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
|                                                              {z                                                              }
ğ‘¡ğ‘’ğ‘Ÿğ‘šğ‘€ 2.(22)
Integrateğ‘¡ğ‘’ğ‘Ÿğ‘šğ¶ 1,ğ‘¡ğ‘’ğ‘Ÿğ‘šğ´ 1andğ‘¡ğ‘’ğ‘Ÿğ‘šğ‘€ 1overğ‘Œ:
ğ¶1=âˆ«
ğ‘(ğ‘…ğ‘)ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]ğ‘‘ğ‘…ğ‘, (23)
ğ´1=âˆ«
ğ‘(ğ‘…ğ‘)ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]ğ‘‘ğ‘…ğ‘, (24)
ğ‘€1=âˆ¬
ğ‘(ğ‘…ğ‘,ğ‘…ğ‘)ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘…ğ‘,(25)
whereğ·ğ¾ğ¿denotes KL-divergence. Integrate ğ‘¡ğ‘’ğ‘Ÿğ‘šğ¶ 2andğ‘¡ğ‘’ğ‘Ÿğ‘šğ´ 2
overğ‘…ğ‘andğ‘…ğ‘, respectively, we have:
ğ¶2=âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œ, (26)
ğ´2=âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œ. (27)
Integrateğ‘¡ğ‘’ğ‘Ÿğ‘šğ‘€ 2overğ‘…ğ‘, we have:
ğ‘€2=âˆ¬
ğ‘(ğ‘Œ,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ. (28)
 
1677KDD â€™24, August 25â€“29, 2024, Barcelona, Spain Xinshu Li, Mingming Gong, and Lina Yao
We further factorize Eq (28) into another two components:âˆ¬
ğ‘(ğ‘Œ,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
=âˆ¬
ğ‘(ğ‘Œ,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ,ğ‘…ğ‘)
ğ‘(ğ‘…ğ‘)
ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
=âˆ¬
ğ‘(ğ‘Œ,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ,ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œâˆ’âˆ¬
ğ‘(ğ‘Œ,ğ‘…ğ‘)ğ‘™ğ‘œğ‘”ğ‘(ğ‘…ğ‘)ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘Œ
=âˆ’ğ»(ğ‘Œ,ğ‘…ğ‘)+ğ»(ğ‘…ğ‘)
=âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘).
(29)
In the view of above, we have the following:
ğ»(ğ‘Œ)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)+ğ»(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)=
âˆ’âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ)ğ‘‘ğ‘Œ
+âˆ«
ğ‘(ğ‘…ğ‘)ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]ğ‘‘ğ‘…ğ‘
+âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œâˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)
âˆ’âˆ¬
ğ‘(ğ‘…ğ‘,ğ‘…ğ‘)ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]ğ‘‘ğ‘…ğ‘ğ‘‘ğ‘…ğ‘+ğ»(ğ‘Œ|ğ‘…ğ‘).
(30)
Based on the non-negativity of KL-divergence, Eq (30)is upper
bounded by:
âˆ’âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ)ğ‘‘ğ‘Œ+âˆ«
ğ‘(ğ‘…ğ‘)ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]ğ‘‘ğ‘…ğ‘
+âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)ğ‘‘ğ‘Œ=
âˆ«
ğ‘(ğ‘…ğ‘)ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]ğ‘‘ğ‘…ğ‘+
âˆ«
ğ‘(ğ‘Œ)ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘(ğ‘Œ)
ğ‘‘ğ‘Œ.
(31)
Equivalently, we have the upper bound as:
Eğ‘…ğ‘âˆ¼ğ¸ğœƒ(ğ‘…ğ‘|ğ‘‹)Eğ‘…ğ‘âˆ¼ğ¸ğœ™(ğ‘…ğ‘|ğ‘‹)[ğ·ğ¾ğ¿[ğ‘(ğ‘Œ|ğ‘…ğ‘)âˆ¥ğ‘(ğ‘Œ|ğ‘…ğ‘)]]
+Eğ‘…ğ‘âˆ¼ğ¸ğœƒ(ğ‘…ğ‘|ğ‘‹)
ğ‘™ğ‘œğ‘”ğ‘(ğ‘Œ|ğ‘…ğ‘)
ğ‘(ğ‘Œ)
,(32)
whereğœƒ,ğœ™denote the parameters of the representation networks
ofğ´andğ¶, respectively. Therefore, the objective of separating ğ¶
andğ´fromğ‘‹can be formalized as:
min
ğœƒ,ğœ™Eğ‘…ğ‘âˆ¼ğ¸ğœƒ(ğ‘…ğ‘|ğ‘‹)Eğ‘…ğ‘âˆ¼ğ¸ğœ™(ğ‘…ğ‘|ğ‘‹)"
ğ·ğ¾ğ¿[Pğ‘…ğ‘
ğ‘Œâˆ¥Pğ‘…ğ‘
ğ‘Œ]+ğ‘™ğ‘œğ‘”"
Pğ‘…ğ‘
ğ‘Œ
Pğ‘Œ##
,
(33)wherePğ‘…ğ‘
ğ‘Œ=ğ‘(ğ‘Œ|ğ‘…ğ‘),Pğ‘…ğ‘
ğ‘Œ=ğ‘(ğ‘Œ|ğ‘…ğ‘)andPğ‘Œdenote the
predicted distributions of ğ‘Œfrom the representations ğ‘…ğ‘,ğ‘…ğ‘and
real distribution of ğ‘Œ, respectively.
Clearly, the first term in Eq (33)is equivalent to minimize the
discrepancy between the predicted distributions of ğ‘Œfrom the repre-
sentationsğ‘…ğ‘,ğ‘…ğ‘. Notice the second term in Eq (33)can be implicitly
reduced by minimizing ğ·ğ¾ğ¿h
Pğ‘…ğ‘
ğ‘Œâˆ¥Pğ‘Œi
. Thus, we have:
min(
ğ·ğ¾ğ¿[Pğ‘Œâˆ¥Pğ‘…ğ‘
ğ‘Œ]
ğ·ğ¾ğ¿[Pğ‘…ğ‘
ğ‘Œâˆ¥Pğ‘…ğ‘
ğ‘Œ]
â‡’minğ»(ğ‘Œ)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)âˆ’ğ»(ğ‘Œ|ğ‘…ğ‘)+ğ»(ğ‘Œ|ğ‘…ğ‘,ğ‘…ğ‘).
Corol.4.2 holds. â–¡
A.2 Reproducibility
A.2.1 Loss Functions for Continuous Scenario. The loss function
for disentangling A is defined as following:
Lğ‘=ğ¿(Ë†ğ‘‡ğ‘,ğ‘‡)+ğ¾ğ¿(Ë†ğ‘‡ğ‘,Ë†ğ‘‡)+ğ¾ğ¿(Ë†ğ‘‡ğ‘,Ë†ğ‘‡ğ‘), (35)
where Ë†ğ‘‡ğ‘£ğ‘ğ‘Ÿğ‘–ğ‘ğ‘ğ‘™ğ‘’ inğ¿(Â·)represents the predicted values for ğ‘£ğ‘ğ‘Ÿğ‘–ğ‘ğ‘ğ‘™ğ‘’
while inğ¾ğ¿(Â·)it denotes the distribution of the variable. Same
below.
We assume that the continuous variable follows a normal distri-
bution, therefore the KL divergence can be calculated with:
KL(ğ‘âˆ¥ğ‘)=logğœ2âˆ’logğœ1+ğœ2
1+(ğœ‡1âˆ’ğœ‡2)2
2ğœ2
2âˆ’1
2, (36)
where qâˆ¼N ğœ‡1,ğœ2
1,pâˆ¼N ğœ‡2,ğœ2
2.
To reduce the confounding bias led by observed confounders,
we define the following loss function:
Lğ‘œğ‘=ğ¿(Ë†ğ‘‡ğ‘§,ğ‘‡)+ğ¾ğ¿(Ë†ğ‘‡ğ‘§,Ë†ğ‘‡)+ğ¾ğ¿(Ë†ğ‘‡ğ‘§,Ë†ğ‘‡Ëœğ‘), (37)
where Ëœğ‘denotes the representation of ğ¶after re-balance network.
Therefore, the total loss function of ğ‘†ğ·2for the continuous
scenario can be devised as:
Lğ‘†ğ·2=ğ¿(Ë†ğ‘Œ,ğ‘Œ)+ğ›¼ğ¿(Ë†ğ‘‡,ğ‘‡)
|                  {z                  }
ğ‘“ğ‘ğ‘ğ‘¡ğ‘¢ğ‘ğ‘™ğ‘™ğ‘œğ‘ ğ‘ +ğ›½Lğ‘+ğ›¾(Lğ‘+Lğ‘§)
|                  {z                  }
ğ‘‘ğ‘–ğ‘ ğ‘’ğ‘›ğ‘¡ğ‘ğ‘›ğ‘”ğ‘™ğ‘’ğ‘šğ‘’ğ‘›ğ‘¡ğ‘™ğ‘œğ‘ ğ‘ 
+ğœ”Lğ‘œğ‘|{z}
ğ‘Ÿğ‘’ğ‘ğ‘ğ‘™ğ‘ğ‘›ğ‘ğ‘’ğ‘™ğ‘œğ‘ ğ‘ +ğ›¿âˆ¥ğ‘Šâˆ¥2|  {z  }
ğ‘Ÿğ‘’ğ‘”ğ‘¢ğ‘™ğ‘ğ‘Ÿğ‘–ğ‘§ğ‘ğ‘¡ğ‘–ğ‘œğ‘›ğ‘™ğ‘œğ‘ ğ‘ .(38)
A.2.2 Hardware. In this work, we perform all experiments on a
cluster with two 12-core Intel Xeon E5-2697 v2 CPUs and a total
768 GiB Memory RAM.
 
1678